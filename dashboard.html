<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Exam Portal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<style>
:root { --body-bg: #F9FAFB; --widget-bg: #FFFFFF; --border-color: #E5E7EB; --text-primary: #002726; --text-secondary: #6B7280; --brand-green: #33C375; --hover-bg: #F3F4F6; --warning-color: #F59E0B; --danger-color: #EF4444; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--body-bg); color: var(--text-primary); font-size: 14px; overflow: hidden; }
.dashboard-container { display: grid; grid-template-columns: 260px 1fr; height: 100vh; position: relative; }
.sidebar { background-color: var(--widget-bg); border-right: 1px solid var(--border-color); padding: 2rem 1.5rem; display: flex; flex-direction: column; position: relative; transition: transform 0.3s ease-in-out; }
.sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; }
.logo-image { height: 40px; }
.main-nav { flex-grow: 1; }
.main-nav ul { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
.main-nav a { display: flex; align-items: center; gap: 1rem; text-decoration: none; color: var(--text-primary); font-weight: 500; padding: 0.75rem 1rem; border-radius: 8px; transition: background-color 0.2s ease, color 0.2s ease; }
.main-nav a i { font-size: 1.5rem; color: var(--text-secondary); transition: color 0.2s ease; }
.main-nav a:hover { background-color: var(--hover-bg); }
.main-nav a.active { background-color: var(--hover-bg); font-weight: 600; }
.main-nav a.active i { color: var(--brand-green); }
.profile-section { margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
.profile-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
.profile-details { flex-grow: 1; min-width: 0; }
.profile-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
.profile-email { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
.profile-options i { font-size: 1.5rem; color: var(--text-secondary); transition: transform 0.2s ease; }
.profile-section.active .profile-options i { transform: rotate(180deg); }
.profile-popup { position: absolute; bottom: 90px; left: 1.5rem; right: 1.5rem; background-color: var(--widget-bg); border-radius: 12px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1); border: 1px solid var(--border-color); padding: 0.75rem; z-index: 100; opacity: 0; pointer-events: none; transform: translateY(10px) scale(0.95); transition: opacity 0.2s ease, transform 0.2s ease; }
.profile-popup.active { opacity: 1; pointer-events: all; transform: translateY(0) scale(1); }
.popup-header { display: flex; align-items: center; gap: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
.popup-list { list-style: none; padding-top: 0.5rem; }
.popup-list a { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem; border-radius: 6px; text-decoration: none; color: var(--text-primary); }
.popup-list a:hover { background-color: var(--hover-bg); }
.popup-list a i { font-size: 1.2rem; color: var(--text-secondary); }
.popup-list a.logout i { color: var(--danger-color); }
.popup-list a.logout { color: var(--danger-color); }
.main-area { display: flex; flex-direction: column; overflow-y: auto; background-color: var(--body-bg); }
.main-header { padding: 1.25rem 3rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--widget-bg); position: sticky; top: 0; z-index: 10; }
.main-header h1 { font-size: 1.5rem; font-weight: 600; }
.search-bar { position: relative; width: 300px; }
.search-bar i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 1.25rem; }
.search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 3rem; border-radius: 8px; border: 1px solid var(--border-color); font-family: 'IBM Plex Sans', sans-serif; font-size: 0.9rem; background-color: var(--body-bg); outline: none; }
.content-body { padding: 2rem 3rem; display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: flex-start; }
.column { display: flex; flex-direction: column; gap: 2rem; }
.widget { background-color: var(--widget-bg); border-radius: 16px; border: 1px solid var(--border-color); padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03), 0 2px 4px -1px rgba(0,0,0,0.02); }
.widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
.widget-header h2 { font-size: 1.125rem; font-weight: 600; }
.widget-header a { font-size: 0.9rem; color: var(--brand-green); text-decoration: none; font-weight: 500; }
.featured-course { background-color: var(--text-primary); color: #FFFFFF; border: none; }
.featured-course h4 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.5rem; }
.featured-course h3 { font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem; }
.progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 10px; margin-bottom: 0.75rem; }
.progress { height: 100%; background: var(--brand-green); border-radius: 10px; width: 0; transition: width 0.5s ease; }
.progress-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
.btn-continue { background: var(--brand-green); color: #FFFFFF; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s ease; text-decoration: none; }
.enrollment-prompt { text-align: center; padding: 2rem; }
.enrollment-prompt h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
.enrollment-prompt p { color: var(--text-secondary); margin-bottom: 1.5rem; }
.course-outline-list { list-style: none; position: relative; padding-left: 1.5rem; }
.course-outline-list::before { content: ''; position: absolute; left: 10px; top: 10px; bottom: 10px; width: 2px; background-color: var(--border-color); }
.outline-item { position: relative; margin-bottom: 1.5rem; } .outline-item:last-child { margin-bottom: 0; }
.outline-marker { position: absolute; left: -24px; top: 0; width: 20px; height: 20px; border-radius: 50%; background-color: var(--widget-bg); border: 2px solid var(--border-color); display: grid; place-items: center; font-size: 0.8rem; }
.outline-item.completed .outline-marker { border-color: var(--brand-green); background-color: var(--brand-green); color: white; }
.outline-item.current .outline-marker { border-color: var(--brand-green); background-color: var(--widget-bg); color: var(--brand-green); width: 24px; height: 24px; left: -26px; top: -2px; }
.outline-item.current .outline-marker::before { content: ''; width: 12px; height: 12px; background-color: var(--brand-green); border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(51, 195, 117, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(51, 195, 117, 0); } 100% { box-shadow: 0 0 0 0 rgba(51, 195, 117, 0); } }
.outline-info h4 { font-weight: 600; } .outline-info p { color: var(--text-secondary); font-size: 0.9rem; }
.outline-item.completed h4 { text-decoration: line-through; color: var(--text-secondary); }
.progress-chart-container { display: flex; align-items: center; gap: 2rem; }
.circular-progress-container { position: relative; width: 120px; height: 120px; }
.progress-ring__svg { transform: rotate(-90deg); }
.progress-ring__circle { transition: stroke-dashoffset 0.8s ease-out; }
.progress-center-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
.progress-center-text strong { display: block; font-size: 2rem; font-weight: 700; color: var(--brand-green); }
.progress-center-text span { font-size: 0.8rem; color: var(--text-secondary); }
.progress-stats { display: flex; flex-direction: column; gap: 1rem; }
.stat p { font-size: 0.9rem; color: var(--text-secondary); } .stat strong { font-size: 1.25rem; font-weight: 600; }
.notification-list { list-style: none; display: flex; flex-direction: column; }
.notification-item { display: flex; align-items: center; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
.notification-item:last-child { border-bottom: none; }
.notification-content { display: flex; align-items: flex-start; gap: 1rem; flex-grow: 1; }
.notification-icon { flex-shrink: 0; width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; font-size: 1.2rem; }
.notification-icon.general { background-color: #E0E7FF; color: #4F46E5; }
.notification-icon.warning { background-color: #FEF3C7; color: var(--warning-color); }
.notification-icon.danger { background-color: #FEE2E2; color: var(--danger-color); }
.notification-info h4 { font-weight: 600; margin-bottom: 0.25rem; }
.notification-info p { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; }
.btn-notification { background: var(--hover-bg); color: var(--text-primary); text-decoration: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; font-size: 0.85rem; white-space: nowrap; margin-left: auto; align-self: center; }
.tab-container { display: flex; position: relative; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
.tab-btn { padding: 0.8rem 1rem; border: none; background: transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: color 0.3s ease; }
.tab-btn.active { color: var(--text-primary); }
.active-line { position: absolute; bottom: 0; height: 2px; background-color: var(--brand-green); border-radius: 2px; transition: left 0.3s ease-in-out, width 0.3s ease-in-out; }
.tab-content { display: none; } .tab-content.active { display: block; }
.profile-list { list-style: none; display: flex; flex-direction: column; gap: 1rem; }
.profile-item { display: flex; align-items: center; }
.profile-item .rank { font-size: 1rem; font-weight: 600; color: var(--text-secondary); width: 30px; }
.profile-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 1rem; object-fit: cover; }
.profile-info { flex-grow: 1; min-width: 0; }
.profile-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.profile-affiliation { color: var(--text-secondary); font-size: 0.85rem; }
.profile-item .score { font-weight: 600; color: var(--brand-green); display: flex; align-items: center; gap: 0.5rem; }
.profile-item .score .crown { color: var(--warning-color); font-size: 1.2rem; }
.profile-list .user-separator { margin: 0.5rem 0; border: 0; height: 1px; background: var(--border-color); }
.menu-toggle { display: none; }
.sidebar-close-btn { display: none; }
.placeholder-text { color: var(--text-secondary); text-align: center; padding: 2rem; }
@media (max-width: 1024px) {
.dashboard-container { grid-template-columns: 1fr; }
.sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 80%; max-width: 300px; z-index: 1000; transform: translateX(-100%); box-shadow: 0 0 30px rgba(0,0,0,0.1); }
.sidebar.active { transform: translateX(0); }
.main-header { padding: 1.25rem 1.5rem; }
.content-body { grid-template-columns: 1fr; padding: 1.5rem; }
.menu-toggle { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; font-size: 1.5rem; color: var(--text-primary); cursor: pointer; border: 2px solid var(--border-color); border-radius: 8px; transition: background-color 0.2s ease; }
.menu-toggle:hover { background-color: var(--hover-bg); }
.sidebar-close-btn { display: flex; align-items: center; justify-content: center; position: absolute; top: 1.5rem; right: 1.5rem; font-size: 1.75rem; color: var(--danger-color); cursor: pointer; border: none; background: none; transition: color 0.2s ease; }
.sidebar-close-btn:hover { color: #b91c1c; }
.overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
.overlay.active { opacity: 1; pointer-events: auto; }
.search-bar { display: none; }
}
</style>
<style>
.skeleton {
animation: shimmer 1.5s infinite linear;
background-color: #f3f4f6;
background-image: linear-gradient(90deg, #f3f4f6 0px, #e5e7eb 40px, #f3f4f6 80px);
background-size: 600px;
border-radius: 4px;
}
@keyframes shimmer {
0% { background-position: -300px 0; }
100% { background-position: 300px 0; }
}
</style>
</head>
<body>
<div class="overlay" id="overlay"></div>
<div class="dashboard-container">
<aside class="sidebar" id="sidebar">
<button class="sidebar-close-btn" id="sidebar-close-btn"><i class='bx bx-x'></i></button>
<div class="sidebar-header"><img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="Ihtnas Logo" class="logo-image"></div>
<nav class="main-nav">
<ul>
<li><a href="dashboard.html" class="active"><i class='bx bx-home-alt'></i> Dashboard</a></li>
<li><a href="course.html"><i class='bx bx-book-open'></i> Course & Content</a></li>
<li><a href="leaderboard.html"><i class='bx bx-bar-chart-alt-2'></i> Leaderboard</a></li>
<li><a href="programs.html"><i class='bx bx-briefcase-alt-2'></i> Explore Programs</a></li>
<li><a href="community.html"><i class='bx bx-group'></i> Community</a></li>
<li><a href="help.html"><i class='bx bx-help-circle'></i> Help & Support</a></li>
</ul>
</nav>
<div class="profile-section" id="profile-section">
<img src="" alt="Profile Picture" class="profile-avatar">
<div class="profile-details">
<span class="profile-name"></span>
<span class="profile-email"></span>
</div>
<div class="profile-options"><i class='bx bx-chevron-down'></i></div>
</div>
<div class="profile-popup" id="profile-popup">
<div class="popup-header">
<img src="" alt="Profile Picture" class="profile-avatar">
<div class="profile-details">
<span class="profile-name"></span>
<span class="profile-email"></span>
</div>
</div>
<ul class="popup-list">
<li><a href="profile.html"><i class='bx bx-user'></i> Profile</a></li>
<li><a href="#" class="logout" id="logout-btn"><i class='bx bx-log-out'></i> Logout</a></li>
</ul>
</div>
</aside>
<main class="main-area">
<header class="main-header">
<i class='bx bx-menu menu-toggle' id="menu-toggle"></i>
<h1>Dashboard</h1>
<div class="search-bar"><i class='bx bx-search'></i><input type="text" placeholder="What do you want to learn today?"></div>
</header>
<section class="content-body">
<div id="skeleton-loader" style="display: contents;">
<div class="column main-col">
<div class="widget">
<div class="skeleton" style="height: 14px; width: 30%; margin-bottom: 0.75rem;"></div>
<div class="skeleton" style="height: 28px; width: 60%; margin-bottom: 1.5rem;"></div>
<div class="skeleton" style="height: 8px; width: 100%; margin-bottom: 0.75rem;"></div>
<div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
<div class="skeleton" style="height: 16px; width: 25%;"></div>
<div class="skeleton" style="height: 16px; width: 25%;"></div>
</div>
<div class="skeleton" style="height: 44px; width: 150px; border-radius: 8px;"></div>
</div>
<div class="widget">
<div class="widget-header">
<div class="skeleton" style="height: 20px; width: 150px;"></div>
</div>
<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
<div class="skeleton" style="width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0;"></div>
<div style="flex-grow: 1;">
<div class="skeleton" style="height: 16px; width: 80%; margin-bottom: 0.5rem;"></div>
<div class="skeleton" style="height: 14px; width: 50%;"></div>
</div>
</div>
<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
<div class="skeleton" style="width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0;"></div>
<div style="flex-grow: 1;">
<div class="skeleton" style="height: 16px; width: 70%; margin-bottom: 0.5rem;"></div>
<div class="skeleton" style="height: 14px; width: 40%;"></div>
</div>
</div>
<div style="display: flex; align-items: center; gap: 1rem;">
<div class="skeleton" style="width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0;"></div>
<div style="flex-grow: 1;">
<div class="skeleton" style="height: 16px; width: 75%; margin-bottom: 0.5rem;"></div>
<div class="skeleton" style="height: 14px; width: 45%;"></div>
</div>
</div>
</div>
</div>
<div class="column side-col">
<div class="widget">
<div class="widget-header">
<div class="skeleton" style="height: 20px; width: 100px;"></div>
</div>
<div class="progress-chart-container">
<div class="skeleton" style="width: 120px; height: 120px; border-radius: 50%;"></div>
<div class="progress-stats" style="gap: 1.5rem;">
<div>
<div class="skeleton" style="height: 14px; width: 120px; margin-bottom: 0.5rem;"></div>
<div class="skeleton" style="height: 20px; width: 80px;"></div>
</div>
<div>
<div class="skeleton" style="height: 14px; width: 100px; margin-bottom: 0.5rem;"></div>
<div class="skeleton" style="height: 20px; width: 70px;"></div>
</div>
</div>
</div>
</div>
<div class="widget">
<div class="widget-header">
<div class="skeleton" style="height: 20px; width: 200px;"></div>
</div>
<div style="padding: 1rem 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
<div class="skeleton" style="width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0;"></div>
<div style="flex-grow: 1;">
<div class="skeleton" style="height: 16px; width: 70%; margin-bottom: 0.5rem;"></div>
<div class="skeleton" style="height: 14px; width: 90%;"></div>
</div>
</div>
<div style="padding: 1rem 0; display: flex; align-items: center; gap: 1rem;">
<div class="skeleton" style="width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0;"></div>
<div style="flex-grow: 1;">
<div class="skeleton" style="height: 16px; width: 60%; margin-bottom: 0.5rem;"></div>
<div class="skeleton" style="height: 14px; width: 80%;"></div>
</div>
</div>
</div>
<div class="widget">
<div class="widget-header">
<div class="skeleton" style="height: 20px; width: 120px;"></div>
<div class="skeleton" style="height: 16px; width: 60px;"></div>
</div>
<div style="display: flex; gap: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem;">
<div class="skeleton" style="height: 24px; width: 80px; margin-bottom: 0.8rem;"></div>
<div class="skeleton" style="height: 24px; width: 80px; margin-bottom: 0.8rem;"></div>
</div>
<div style="padding-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
<div class="skeleton" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;"></div>
<div style="flex-grow: 1;">
<div class="skeleton" style="height: 16px; width: 80%; margin-bottom: 0.5rem;"></div>
<div class="skeleton" style="height: 14px; width: 50%;"></div>
</div>
</div>
<div style="padding-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
<div class="skeleton" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;"></div>
<div style="flex-grow: 1;">
<div class="skeleton" style="height: 16px; width: 70%; margin-bottom: 0.5rem;"></div>
<div class="skeleton" style="height: 14px; width: 40%;"></div>
</div>
</div>
</div>
</div>
</div>
<div id="real-content" style="display: none; contents;">
<div class="column main-col">
<div class="widget featured-course" id="featured-course-widget" style="display: none;">
<h4>CONTINUE LEARNING</h4>
<h3 id="featured-course-title"></h3>
<div class="progress-bar"><div class="progress" id="featured-course-progress"></div></div>
<div class="progress-info"><span id="featured-course-subject"></span><span id="featured-course-percent"></span></div>
<a href="#" class="btn-continue" id="featured-course-link">Continue Learning</a>
</div>
<div class="widget" id="enrollment-prompt" style="display: none;">
<div class="enrollment-prompt">
<h3>Welcome to the Portal!</h3>
<p>You are not yet enrolled in any courses. Enroll now to start your learning journey.</p>
<a href="course-enroll.html" class="btn-continue">Enroll in a Course</a>
</div>
</div>
<div class="widget" id="course-outline-widget" style="display: none;">
<div class="widget-header"><h2>Course Outline</h2></div>
<ol class="course-outline-list" id="course-outline-list"></ol>
</div>
</div>
<div class="column side-col">
<div class="widget">
<div class="widget-header"><h2>Progress</h2></div>
<div class="progress-chart-container">
<div class="circular-progress-container">
<svg class="progress-ring__svg" width="120" height="120">
<circle stroke="#E5E7EB" stroke-width="10" fill="transparent" r="52" cx="60" cy="60"/>
<circle class="progress-ring__circle" id="overall-progress-ring" stroke="var(--brand-green)" stroke-linecap="round" stroke-width="10" fill="transparent" r="52" cx="60" cy="60" stroke-dasharray="326.7" stroke-dashoffset="326.7"/>
</svg>
<div class="progress-center-text"><strong id="overall-progress-percent">0%</strong><span>Completed</span></div>
</div>
<div class="progress-stats">
<div class="stat"><p>Lessons Completed</p><strong id="lessons-completed-stat">0 / 0</strong></div>
<div class="stat"><p>Assessments</p><strong id="assessments-completed-stat">0 / 0</strong></div>
</div>
</div>
</div>
<div class="widget">
<div class="widget-header"><h2>Notifications & Deadlines</h2></div>
<ul class="notification-list" id="notification-list"></ul>
</div>
<div class="widget">
<div class="widget-header"><h2>Leaderboard</h2><a href="leaderboard.html">View All</a></div>
<div class="tab-container">
<button class="tab-btn active" data-target="#my-college-content">My College</button>
<button class="tab-btn" data-target="#overall-content">Overall</button>
<div class="active-line"></div>
</div>
<div id="my-college-content" class="tab-content active"><ul class="profile-list" id="college-leaderboard-list"></ul></div>
<div id="overall-content" class="tab-content"><ul class="profile-list" id="overall-leaderboard-list"></ul></div>
</div>
</div>
</div>
</section>
</main>
</div>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const firebaseConfig = {
            apiKey: "AIzaSyCSW52Vl2UIC7eeM4uXKcSPdHflZCl3WJQ",
            authDomain: "exam-2e799.firebaseapp.com",
            projectId: "exam-2e799",
            storageBucket: "exam-2e799.firebasestorage.app",
            messagingSenderId: "472506328501",
            appId: "1:472506328501:web:f239c42baed2f4b9f925fc",
            measurementId: "G-NX21HT3JKT"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                if (user.email === ADMIN_EMAIL) { window.location.href = 'admin.html'; return; }
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) { window.location.href = 'index.html'; return; }
                
                const userProfile = userDoc.data();
                initUI(userProfile);
                loadDashboardData(user.uid, userProfile);
            } else {
                window.location.href = 'index.html';
            }
        });

        const initUI = (userProfile) => {
            document.querySelectorAll('.profile-avatar').forEach(el => el.src = userProfile.photoURL || '');
            document.querySelectorAll('.profile-name').forEach(el => el.textContent = userProfile.displayName);
            document.querySelectorAll('.profile-email').forEach(el => el.textContent = userProfile.email);
            
            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
            
            const tabs = document.querySelectorAll('.tab-btn');
            const activeLine = document.querySelector('.active-line');
            function moveActiveLine(tabElement) { if (tabElement) { activeLine.style.width = `${tabElement.offsetWidth}px`; activeLine.style.left = `${tabElement.offsetLeft}px`; } }
            moveActiveLine(document.querySelector('.tab-btn.active'));
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.querySelector(tab.dataset.target).classList.add('active');
                    moveActiveLine(tab);
                });
            });

            const profileSection = document.getElementById('profile-section');
            const profilePopup = document.getElementById('profile-popup');
            profileSection.addEventListener('click', e => { e.stopPropagation(); profilePopup.classList.toggle('active'); profileSection.classList.toggle('active'); });
            document.addEventListener('click', e => { if (!profileSection.contains(e.target)) { profilePopup.classList.remove('active'); profileSection.classList.remove('active'); } });
            
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const closeBtn = document.getElementById('sidebar-close-btn');
            const overlay = document.getElementById('overlay');
            const toggleMenu = () => { sidebar.classList.toggle('active'); overlay.classList.toggle('active'); };
            menuToggle.addEventListener('click', toggleMenu);
            closeBtn.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);
        };

        const loadDashboardData = async (userId, userProfile) => {
            const skeletonLoader = document.getElementById('skeleton-loader');
            const realContent = document.getElementById('real-content');
            try {
                const enrollmentsSnap = await db.collection('enrollments').where('userId', '==', userId).get();

                const [coursesSnap, examsSnap, progressSnap, scoresSnap, usersSnap, subjectsSnap, notificationsSnap] = await Promise.all([
                    db.collection('courses').get(), db.collection('exams').get(),
                    db.collection('users').doc(userId).collection('progress').get(),
                    db.collection('scores').get(), db.collection('users').get(), db.collection('subjects').get(),
                    db.collection('notifications').orderBy('createdAt', 'desc').get()
                ]);

                const allExams = examsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const userScores = new Map(scoresSnap.docs.filter(d => d.data().userId === userId).map(d => [d.data().examId, d.data()]));
                renderNotifications(notificationsSnap, allExams, userScores);

                if (enrollmentsSnap.empty) {
                    document.getElementById('enrollment-prompt').style.display = 'block';
                    document.getElementById('featured-course-widget').style.display = 'none';
                    document.getElementById('course-outline-widget').style.display = 'none';
                } else {
                    document.getElementById('enrollment-prompt').style.display = 'none';
                    const allCourses = coursesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const userProgress = new Set(progressSnap.docs.map(doc => doc.data().lessonId));
                    const allSubjects = new Map(subjectsSnap.docs.map(doc => [doc.id, doc.data()]));
                    const lessonsPromises = allCourses.map(c => db.collection('lessons').where('courseId', '==', c.id).get());
                    const lessonsSnaps = await Promise.all(lessonsPromises);
                    const allLessons = lessonsSnaps.flatMap(snap => snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    renderFeaturedCourse(allCourses, allLessons, allSubjects, userProgress);
                }
                
                const allUsers = new Map(usersSnap.docs.map(doc => [doc.id, doc.data()]));
                renderOverallProgress(progressSnap.size, allExams.length, userScores.size);
                renderLeaderboards(scoresSnap, allUsers, userId, userProfile);
            } finally {
                skeletonLoader.style.display = 'none';
                realContent.style.display = 'contents';
            }
        };

        const renderFeaturedCourse = (courses, lessons, subjects, progress) => {
            const startedCourses = courses.filter(course => lessons.some(l => l.courseId === course.id && progress.has(l.id)));
            let featuredCourse = startedCourses.find(c => {
                const courseLessons = lessons.filter(l => l.courseId === c.id);
                return courseLessons.length > 0 && courseLessons.some(l => !progress.has(l.id));
            });
            if (!featuredCourse && courses.length > 0) { featuredCourse = courses[0]; }
            
            if (featuredCourse) {
                document.getElementById('featured-course-widget').style.display = 'block';
                document.getElementById('course-outline-widget').style.display = 'block';
                const courseLessons = lessons.filter(l => l.courseId === featuredCourse.id).sort((a,b) => a.chapterIndex - b.chapterIndex || a.order - b.order);
                const completed = courseLessons.filter(l => progress.has(l.id)).length;
                const percent = courseLessons.length > 0 ? Math.round((completed / courseLessons.length) * 100) : 0;
                
                document.getElementById('featured-course-title').textContent = featuredCourse.name;
                document.getElementById('featured-course-subject').textContent = `in ${subjects.get(featuredCourse.subjectId)?.name || ''}`;
                document.getElementById('featured-course-progress').style.width = `${percent}%`;
                document.getElementById('featured-course-percent').textContent = `${percent}% Complete`;
                document.getElementById('featured-course-link').href = `course-view.html?id=${featuredCourse.id}`;
                
                const outlineList = document.getElementById('course-outline-list');
                outlineList.innerHTML = '';
                featuredCourse.chapters.forEach((chapterName, index) => {
                    const lessonsInChapter = courseLessons.filter(l => l.chapterIndex === index);
                    if (lessonsInChapter.length === 0) return;
                    const completedInChapter = lessonsInChapter.filter(l => progress.has(l.id)).length;
                    const isChapterCompleted = completedInChapter === lessonsInChapter.length;
                    const firstUncompleted = courseLessons.find(l => !progress.has(l.id));
                    const isCurrentChapter = firstUncompleted && firstUncompleted.chapterIndex === index;
                    const item = document.createElement('li');
                    item.className = `outline-item ${isChapterCompleted ? 'completed' : ''} ${isCurrentChapter ? 'current' : ''}`;
                    item.innerHTML = `<div class="outline-marker">${isChapterCompleted ? "<i class='bx bx-check'></i>" : ''}</div><div class="outline-info"><h4>${chapterName}</h4><p>${completedInChapter} / ${lessonsInChapter.length} lessons</p></div>`;
                    outlineList.appendChild(item);
                });
            }
        };
        
        const renderOverallProgress = (completedLessons, totalExams, completedExams) => {
            db.collection('lessons').get().then(lessonsSnap => {
                const totalLessons = lessonsSnap.size;
                const overallPercent = (totalLessons + totalExams > 0) ? Math.round(((completedLessons + completedExams) / (totalLessons + totalExams)) * 100) : 0;
                document.getElementById('lessons-completed-stat').textContent = `${completedLessons} / ${totalLessons}`;
                document.getElementById('assessments-completed-stat').textContent = `${completedExams} / ${totalExams}`;
                document.getElementById('overall-progress-percent').textContent = `${overallPercent}%`;
                const ring = document.getElementById('overall-progress-ring');
                const radius = ring.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                ring.style.strokeDasharray = `${circumference} ${circumference}`;
                const offset = circumference - (overallPercent / 100) * circumference;
                ring.style.strokeDashoffset = offset;
            });
        };

        const renderLeaderboards = (scoresSnap, users, currentUserId, currentUserProfile) => {
            const userPoints = {};
            scoresSnap.forEach(doc => {
                const score = doc.data();
                userPoints[score.userId] = (userPoints[score.userId] || 0) + score.pointsReceived;
            });
            const sortedUsers = Object.keys(userPoints).sort((a,b) => userPoints[b] - userPoints[a]);
            const createLeaderboardHTML = (userList) => {
                if (userList.length === 0) {
                    return `<li class="profile-item"><span class="rank">1</span><img src="${currentUserProfile.photoURL}" alt="${currentUserProfile.displayName}"><div class="profile-info"><p class="profile-name">${currentUserProfile.displayName} (You)</p><p class="profile-affiliation">${currentUserProfile.college}</p></div><span class="score">0 XP</span></li>`;
                }
                let html = '';
                userList.slice(0, 3).forEach((userId, index) => {
                    const user = users.get(userId);
                    if(user) html += `<li class="profile-item"><span class="rank">${index + 1}</span><img src="${user.photoURL}" alt="${user.displayName}"><div class="profile-info"><p class="profile-name">${user.displayName}</p><p class="profile-affiliation">${user.college}</p></div><span class="score">${index === 0 ? "<i class='bx bxs-crown crown'></i>": ""} ${userPoints[userId]} XP</span></li>`;
                });
                const currentUserRank = userList.indexOf(currentUserId);
                if (currentUserRank >= 3) {
                     const user = users.get(currentUserId);
                     html += `<hr class="user-separator"><li class="profile-item"><span class="rank">${currentUserRank + 1}</span><img src="${user.photoURL}" alt="${user.displayName}"><div class="profile-info"><p class="profile-name">${user.displayName} (You)</p><p class="profile-affiliation">${user.college}</p></div><span class="score">${userPoints[currentUserId]} XP</span></li>`;
                }
                return html;
            };
            document.getElementById('overall-leaderboard-list').innerHTML = createLeaderboardHTML(sortedUsers);
            const collegeUsers = sortedUsers.filter(userId => users.get(userId)?.college === currentUserProfile.college);
            document.getElementById('college-leaderboard-list').innerHTML = createLeaderboardHTML(collegeUsers);
        };

        const renderNotifications = (notificationsSnap, allExams, userScores) => {
            const list = document.getElementById('notification-list');
            const oneDay = 1000 * 60 * 60 * 24;
            const threeDays = oneDay * 3;
            const now = new Date();
            
            const items = [];
            notificationsSnap.forEach(doc => { items.push({ type: 'general', data: doc.data(), docId: doc.id, timestamp: doc.data().createdAt }); });

            allExams.forEach(exam => {
                if (exam.deadline && !exam.isLocked && !userScores.has(exam.id)) {
                    const deadlineDate = new Date(exam.deadline.seconds * 1000);
                    const diff = deadlineDate - now;
                    if (diff > 0 && diff <= threeDays) {
                        items.push({ type: 'exam', data: exam, docId: exam.id, timestamp: exam.deadline, diff: diff });
                    }
                }
            });

            items.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
            list.innerHTML = '';
            
            if (items.length === 0) {
                list.parentElement.innerHTML = '<p class="placeholder-text">No notifications at this time.</p>';
                return;
            }

            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'notification-item';
                let iconClass, icon, heading, text, buttonHtml = '';

                if (item.type === 'general') {
                    iconClass = 'general'; icon = "<i class='bx bxs-bell'></i>"; heading = item.data.heading; text = item.data.text;
                    if (item.data.buttonText && item.data.buttonLink) {
                        buttonHtml = `<a href="${item.data.buttonLink}" class="btn-notification">${item.data.buttonText}</a>`;
                    }
                } else if (item.type === 'exam') {
                    const daysLeft = Math.ceil(item.diff / oneDay);
                    if (item.diff <= oneDay) {
                        iconClass = 'danger'; icon = "<i class='bx bxs-error-circle'></i>"; text = `Deadline is in less than 24 hours.`;
                    } else {
                        iconClass = 'warning'; icon = "<i class='bx bxs-error-alt'></i>"; text = `Deadline is in ${daysLeft} days.`;
                    }
                    heading = `${item.data.name} Deadline`;
                }
                
                li.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-icon ${iconClass}">${icon}</div>
                        <div class="notification-info">
                            <h4>${heading}</h4>
                            <p>${text}</p>
                        </div>
                    </div>
                    ${buttonHtml}
                `;
                list.appendChild(li);
            });
        };
    });
</script>
</body>
</html>
