<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enroll in a Subject</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root { --body-bg: #F9FAFB; --widget-bg: #FFFFFF; --border-color: #E5E7EB; --text-primary: #002726; --text-secondary: #6B7280; --brand-green: #33C375; --hover-bg: #F3F4F6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--body-bg); color: var(--text-primary); display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .enrollment-container { background-color: var(--widget-bg); border-radius: 16px; border: 1px solid var(--border-color); padding: 2.5rem; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); text-align: center; max-width: 450px; width: 100%; }
        .enrollment-container h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem; }
        .enrollment-container p { color: var(--text-secondary); margin-bottom: 2rem; }
        .form-field { margin-bottom: 1.5rem; text-align: left; }
        .form-field label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        .form-field select { width: 100%; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); font-family: 'IBM Plex Sans', sans-serif; font-size: 1rem; background-color: #FFFFFF; outline: none; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .form-field select:focus { border-color: var(--brand-green); box-shadow: 0 0 0 3px rgba(51, 195, 117, 0.2); }
        .btn { width: 100%; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; }
        .btn-primary { background: var(--text-primary); color: #FFFFFF; }
        .btn-primary:hover { background: #001A19; }
        .btn:disabled { background-color: #D1D5DB; cursor: not-allowed; }
        .btn-google { background-color: #4285F4; color: #FFFFFF; }
        .btn-google:hover { background-color: #357ae8; }
        .user-info { font-weight: 500; margin-bottom: 2rem; }
        .status-message { margin-top: 1rem; font-weight: 500; }
        .status-message.success { color: var(--brand-green); }
        .status-message.error { color: #EF4444; }
    </style>
</head>
<body>
    <div class="enrollment-container">
        <h1>Enroll in a Subject</h1>
        <p>Select a subject below to begin your learning journey.</p>
        
        <div id="auth-section">
            <button class="btn btn-google" id="login-btn"><i class='bx bxl-google'></i> Sign In with Google</button>
        </div>
        
        <div id="form-section" style="display: none;">
            <p class="user-info">Welcome, <span id="user-name"></span>!</p>
            <form id="enrollment-form">
                <div class="form-field">
                    <label for="subject-select">Choose a Subject</label>
                    <select id="subject-select" required></select>
                </div>
                <button type="submit" class="btn btn-primary" id="confirm-btn">Confirm Enrollment</button>
            </form>
        </div>

        <div id="status-message" class="status-message"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCSW52Vl2UIC7eeM4uXKcSPdHflZCl3WJQ",
                authDomain: "exam-2e799.firebaseapp.com",
                projectId: "exam-2e799",
                storageBucket: "exam-2e799.firebasestorage.app",
                messagingSenderId: "472506328501",
                appId: "1:472506328501:web:f239c42baed2f4b9f925fc",
                measurementId: "G-NX21HT3JKT"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            const dom = {
                authSection: document.getElementById('auth-section'),
                formSection: document.getElementById('form-section'),
                loginBtn: document.getElementById('login-btn'),
                userName: document.getElementById('user-name'),
                subjectSelect: document.getElementById('subject-select'),
                confirmBtn: document.getElementById('confirm-btn'),
                statusMessage: document.getElementById('status-message')
            };

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    dom.authSection.style.display = 'none';
                    dom.userName.textContent = user.displayName;
                    dom.formSection.style.display = 'block';
                    await fetchAndPopulateSubjects(user.uid);
                } else {
                    dom.authSection.style.display = 'block';
                    dom.formSection.style.display = 'none';
                }
            });

            const fetchAndPopulateSubjects = async (userId) => {
                dom.subjectSelect.innerHTML = '<option value="">Loading subjects...</option>';
                dom.subjectSelect.disabled = true;

                const [subjectsSnap, enrollmentsSnap] = await Promise.all([
                    db.collection('subjects').get(),
                    db.collection('enrollments').where('userId', '==', userId).get()
                ]);

                const enrolledSubjectIds = new Set(enrollmentsSnap.docs.map(doc => doc.data().subjectId));

                dom.subjectSelect.innerHTML = '<option value="">-- Select a subject --</option>';
                subjectsSnap.forEach(doc => {
                    const subject = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = subject.name;
                    option.dataset.subjectPage = subject.page;
                    
                    if (enrolledSubjectIds.has(doc.id)) {
                        option.textContent += ' (Enrolled)';
                        option.disabled = true;
                    }
                    dom.subjectSelect.appendChild(option);
                });
                dom.subjectSelect.disabled = false;
            };

            const signIn = () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(error => console.error("Sign-in error", error));
            };

            dom.loginBtn.addEventListener('click', signIn);

            document.getElementById('enrollment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) {
                    dom.statusMessage.textContent = 'Please sign in to enroll.';
                    dom.statusMessage.className = 'status-message error';
                    return;
                }

                const selectedOption = dom.subjectSelect.options[dom.subjectSelect.selectedIndex];
                const subjectId = selectedOption.value;
                const subjectName = selectedOption.textContent;
                const subjectPage = selectedOption.dataset.subjectPage;

                if (!subjectId) {
                    dom.statusMessage.textContent = 'Please select a valid subject.';
                    dom.statusMessage.className = 'status-message error';
                    return;
                }

                dom.confirmBtn.disabled = true;
                dom.confirmBtn.textContent = 'Enrolling...';

                try {
                    await db.collection('enrollments').add({
                        userId: user.uid,
                        subjectId: subjectId,
                        subjectName: subjectName.replace(' (Enrolled)', ''),
                        subjectPage: subjectPage,
                        enrolledAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    dom.statusMessage.textContent = 'Enrollment successful! Redirecting...';
                    dom.statusMessage.className = 'status-message success';
                    setTimeout(() => { window.location.href = subjectPage; }, 2000);

                } catch (error) {
                    console.error("Enrollment error: ", error);
                    dom.statusMessage.textContent = 'An error occurred. Please try again.';
                    dom.statusMessage.className = 'status-message error';
                    dom.confirmBtn.disabled = false;
                    dom.confirmBtn.textContent = 'Confirm Enrollment';
                }
            });
        });
    </script>
</body>
</html>
